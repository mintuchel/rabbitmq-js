# Message Queue를 사용하는 이유

# Message-Oriented Middleware

메시지 지향 미들웨어란 응용 소프트웨어 간의 비동기적 통신을 위한 미들웨어이다.

즉, 비동기적(asynchronous)인 방식을 이용해서 프로세스 간 데이터와 메시지를 주고 받는 기능을 위한 시스템이다. MOM은 메시지를 전달하는 과정에서 메시지를 보관/저장하거나 라우팅 및 변환할 수 있다는 장점을 가진다.

# Message Queue를 사용하는 이유

## 1. 비동기 (Asynchronous)

메시지큐를 사용하지 않는다면 메시지를 발행하는 Producer가 Consumer에게 직접적으로 메시지를 보내야한다. 이 때문에 해당 과정이 완료되기 전까지는 다른 메시지 처리 과정을 진행하지 못한다. 이러한 방식을 동기적 방식이라고 하며 전송속도가 빠르고 전송결과를 신속하게 알 수 있다는 장점이 있지만, 대용량 트래픽이 발생하는 상황에서는 매우 비효율적이다.

이를 해결하기 위해 메시지큐를 중간에 배치하여 Producer에게 메시지를 Consumer에게 바로 보내지 않고 Queue를 통해 저장한 후, Consumer가 비동기적으로 Queue에 있는 메시지를 처리하게 한다.

## 2. 낮은 결합도 (Decoupling)

메시지큐를 통해 각 서비스들 간의 직접적인 참조를 지양하고 메시지큐를 통해 통신하는 구조로 아키텍처를 구성해놓음으로써 각 어플리케이션들간의 결합도를 낮출 수 있다.

결합도가 낮은 경우, 확장성, 유연성, 효율적인 유지보수, 장애전파방지 등의 장점을 얻을 수 있고, 마이크로서비스 아키텍처에서 메시지큐를 활용하여 이러한 장점을 꾀한다.

## 3. 탄력성 (Resilience)

낮은 결합도는 시스템의 탄력성을 높이는데 기여한다. 탄력성이란 예기치 않은 상황 또는 장애에 대응하고 유연하게 대처할 수 있는 능력을 의미한다.

예를 들어, 현재 서비스 A와 서비스 B가 통신한다고 가정해보자.

메시지큐가 없는 경우, 서비스 B에 장애가 발생하면 그 영향이 서비스 A에도 전파가 되어 장애가 복구되는 동안 A,B 두 서비스 동작이 멈추는 블로킹 상황이 발생할 수 있다. 왜냐하면 A와 B 모두 메시지큐를 사용하지 않고 서로를 직접적으로 참조하며 통신하고 있기 때문이다. 즉, 서비스 B에서 발생한 장애가 정상적으로 돌아가던 서비스 A까지 전파된 것이다.

하지만 메시지큐가 있다면 장애가 전파되는 것을 막을 수 있다. A 프로세스는 B 프로세스의 장애여부와는 상관없이 자신이 보내는 메시지를 메시지큐에만 전달해주면 되기 때문이다. 메시지큐는 서버와 독립적으로 동작하며, 메시지를 디스크에 저장해 장애 시에도 데이터를 보존할 수 있기 때문이다. 이로써 장애를 B에만 국한시키고 다른 서비스로의 확산을 막을 수 있다.

## 4. 내구성 (Durability/Persistency)

내구성이란, 메시지 송수신이 실패하더라도 메시지를 유실하지 않고 재처리할 수 있는 특성이다. 메시지 큐가 없는 경우 서비스 B에서 장애가 발생하는 경우, 서비스 A가 B에게 보낸 메시지들이 유실되고, 처리중이던 메시지에 대한 데이터가 날라가는 등 다양한 문제가 발생할 수 있다.

하지만 메시지큐를 사용하면 메시지들을 모두 메시지큐가 보관하고, Consumer에서 제대로 처리되지 않은 메시지들을 다시 큐에 넣는 작업을 통해 제대로 처리되지 않은 메시지들에 대한 재처리 작업을 지원해준다. 또한 서비스 장애 시 메시지들은 메시지큐에 보관되어 메시지 유실을 방지한다.

## 5. 확장성 (Scalable)

메시지큐를 활용하면 대용량 트래픽이 발생하거나 통신에서 부하가 증가할때, Producer와 Consumer만 적재적소로 추가함으로써 트래픽을 쉽게 해결할 수 있다. 대기열이 커진다면 Consumer를 더 추가하고 해당 작업을 병렬화하는 것이 표준이다.

# Message Queue vs async/await ?

async/await 은 단일 프로세스 내부에서 Non-Blocking 적으로 처리하기 위한 비동기이고 메시지큐는 서비스 간 분리와 서비스들 간의 비동기적 통신을 위한 비동기이다. 즉 ‘비동기’의 목적이 다른 것이다.

단일 프로세스 내부에서 사용되는 async/await은 단일 프로세스에서 최대한 효율적으로 일을 하기 위해 비동기적으로 처리될 수 있는 것들은 비동기적으로 처리하게 하는 것이다.

메시지큐에서의 비동기는 각 서비스 간의 통신에 대한 의무를 메시지큐에게 넘김으로써 각 서비스들이 서로 어떤 일을 처리하는지 몰라도 된다는 면에서 서비스 분리(낮은 결합도)를 통한 비동기적인 처리라고 하는 것이다.
